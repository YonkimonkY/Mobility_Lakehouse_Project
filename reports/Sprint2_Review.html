
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sprint2_review</title>
    <style>
        @media print {
            @page {
                margin: 2cm;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
            pre, blockquote, table {
                page-break-inside: avoid;
            }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #3498db;
            padding-bottom: 15px;
            margin-top: 40px;
            font-size: 2.2em;
        }
        
        h1:first-child {
            margin-top: 0;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #95a5a6;
            padding-bottom: 10px;
            margin-top: 35px;
            font-size: 1.8em;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
            font-size: 1.4em;
        }
        
        h4 {
            color: #95a5a6;
            margin-top: 20px;
            font-size: 1.2em;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
            border: 1px solid #e1e4e8;
        }
        
        pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.5;
            border: 1px solid #dfe2e5;
        }
        
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border: none;
            font-size: 1em;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 0.95em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e9ecef;
        }
        
        blockquote {
            border-left: 5px solid #3498db;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #555;
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-radius: 0 4px 4px 0;
        }
        
        ul, ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        em {
            color: #7f8c8d;
        }
        
        a {
            color: #3498db;
            text-decoration: none;
            border-bottom: 1px dotted #3498db;
        }
        
        a:hover {
            color: #2980b9;
            border-bottom: 1px solid #2980b9;
        }
        
        hr {
            border: none;
            border-top: 2px solid #e1e4e8;
            margin: 30px 0;
        }
        
        .toc {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
        }
        
        .toc h2 {
            margin-top: 0;
            border-bottom: 2px solid #3498db;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #3498db;
        }
        
        .header h1 {
            border: none;
            margin-bottom: 10px;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #e1e4e8;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .note {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
        
        .warning {
            background-color: #f8d7da;
            border-left: 5px solid #dc3545;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
        
        .success {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sprint 2: Mobility Lakehouse</h1>
            <p>DocumentaciÃ³n tÃ©cnica completa</p>
            <p style="color: #7f8c8d;">Generado: 2025-12-04</p>
        </div>
        
        <h1 id="sprint-2-review-lakehouse-implementation-and-ingestion">Sprint 2 Review: Lakehouse Implementation and Ingestion</h1>
<h2 id="resumen-ejecutivo">ğŸ“‹ Resumen Ejecutivo</h2>
<p><strong>Objetivo del Sprint 2</strong>: Construir la arquitectura core del lakehouse (DuckLake) e implementar los scripts de ingesta para todas las fuentes de datos (MITMA, INE).</p>
<p><strong>Estado</strong>: âœ… <strong>COMPLETADO CON Ã‰XITO</strong></p>
<ul>
<li>âœ… Ingesta exitosa de todas las fuentes</li>
<li>âœ… ValidaciÃ³n de datos en Bronze</li>
<li>âœ… CreaciÃ³n de tablas Silver optimizadas</li>
<li>âœ… ImplementaciÃ³n del Modelo de Gravedad en Gold</li>
</ul>
<hr />
<h2 id="arquitectura-del-lakehouse">ğŸ—ï¸ Arquitectura del Lakehouse</h2>
<h3 id="decision-tecnica-duckdb-sistema-de-archivos-local">DecisiÃ³n TÃ©cnica: DuckDB + Sistema de Archivos Local</h3>
<p><strong>Â¿Por quÃ© DuckDB y no otro sistema?</strong></p>
<ol>
<li>
<p><strong>Rendimiento AnalÃ­tico Superior</strong></p>
</li>
<li>
<p>DuckDB es un motor OLAP (Online Analytical Processing) optimizado para queries analÃ­ticas</p>
</li>
<li>Procesamiento columnar â†’ ideal para agregaciones y GROUP BY masivos</li>
<li>EjecuciÃ³n vectorizada â†’ procesa datos en bloques en lugar de fila por fila</li>
<li>
<p><strong>Resultado</strong>: Procesa millones de registros en segundos</p>
</li>
<li>
<p><strong>Simplicidad de Despliegue</strong></p>
</li>
<li>
<p>No requiere servidor â†’ archivo <code>.duckdb</code> local</p>
</li>
<li>Zero-configuration â†’ no hay que instalar servicios externos</li>
<li>Portabilidad â†’ el <code>.duckdb</code> se puede copiar entre mÃ¡quinas</li>
<li>
<p><strong>Resultado</strong>: IteraciÃ³n rÃ¡pida sin fricciÃ³n de infraestructura</p>
</li>
<li>
<p><strong>IntegraciÃ³n con Python</strong></p>
</li>
<li>API nativa de Python â†’ <code>import duckdb</code></li>
<li>Compatible con Pandas/GeoPandas â†’ <code>df.to_duckdb()</code>, <code>con.execute().df()</code></li>
<li>Extensiones espaciales â†’ <code>INSTALL spatial; LOAD spatial;</code></li>
<li><strong>Resultado</strong>: Pipeline end-to-end en Python sin cambiar de lenguaje</li>
</ol>
<h3 id="arquitectura-en-3-capas-medallion-architecture">Arquitectura en 3 Capas (Medallion Architecture)</h3>
<div class="codehilite"><pre><span></span><code>RAW DATA (CSV/Parquet)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BRONZE LAYER          â”‚  â† Ingesta cruda (schema-on-read)
â”‚   bronze.duckdb         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SILVER LAYER          â”‚  â† Modelo dimensional (star schema)
â”‚   silver.duckdb         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GOLD LAYER            â”‚  â† MÃ©tricas analÃ­ticas + ML
â”‚   gold.duckdb           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Â¿Por quÃ© 3 capas separadas?</strong></p>
<ol>
<li>
<p><strong>Bronze (Zona de Aterrizaje)</strong></p>
</li>
<li>
<p><strong>PropÃ³sito</strong>: Replicar datos raw sin transformaciones</p>
</li>
<li><strong>Ventaja</strong>: Si se rompe algo en Silver/Gold, puedes reprocesar desde Bronze</li>
<li><strong>Schema-on-Read</strong>: No validamos tipos de datos â†’ cargamos todo como VARCHAR</li>
<li>
<p><strong>Inmutabilidad</strong>: Una vez cargado, no se modifica</p>
</li>
<li>
<p><strong>Silver (Modelo Dimensional)</strong></p>
</li>
<li>
<p><strong>PropÃ³sito</strong>: Datos limpios, tipados, y modelados para anÃ¡lisis</p>
</li>
<li><strong>Star Schema</strong>: Tablas de dimensiones (zonas, calendario) + hechos (viajes, personas)</li>
<li><strong>NormalizaciÃ³n</strong>: Eliminamos duplicados (e.g., zona "Madrid" solo existe una vez)</li>
<li>
<p><strong>ValidaciÃ³n</strong>: Convertimos tipos de datos (VARCHAR â†’ DATE, INTEGER)</p>
</li>
<li>
<p><strong>Gold (Capa AnalÃ­tica)</strong></p>
</li>
<li><strong>PropÃ³sito</strong>: KPIs, agregaciones, modelos de Machine Learning</li>
<li><strong>Desnormalizado</strong>: Tablas planas optimizadas para BI tools</li>
<li><strong>Precalculado</strong>: Las agregaciones costosas se calculan una vez</li>
<li><strong>Ejemplo</strong>: Top 1000 flujos OD, Modelo de Gravedad</li>
</ol>
<hr />
<h2 id="ingesta-de-datos-bronze-layer">ğŸ“¥ Ingesta de Datos (Bronze Layer)</h2>
<h3 id="script-srcingest_bronzepy">Script: <code>src/ingest_bronze.py</code></h3>
<h4 id="fuentes-de-datos-procesadas">Fuentes de Datos Procesadas</h4>
<ol>
<li>
<p><strong>MITMA (Ministerio de Transportes)</strong></p>
</li>
<li>
<p><code>bronze_mitma_viajes</code> â†’ Viajes origen-destino por hora</p>
</li>
<li><code>bronze_mitma_personas</code> â†’ Personas pernoctando por zona</li>
<li><strong>Formato</strong>: CSV (100+ millones de filas)</li>
<li>
<p><strong>Esquema</strong>: <code>fecha, periodo, origen, destino, edad, sexo, viajes, viajes_km</code></p>
</li>
<li>
<p><strong>INE (Instituto Nacional de EstadÃ­stica)</strong></p>
</li>
<li>
<p><code>bronze_ine_zones</code> â†’ CatÃ¡logo de zonas (distritos, municipios, GAUs)</p>
</li>
<li><code>bronze_ine_demographics</code> â†’ Datos demogrÃ¡ficos por zona</li>
<li><code>bronze_ine_economic</code> â†’ Indicadores econÃ³micos</li>
<li>
<p><code>bronze_ine_relacion</code> â†’ RelaciÃ³n jerÃ¡rquica distrito â†’ municipio â†’ GAU</p>
</li>
<li>
<p><strong>Datos Geoespaciales</strong></p>
</li>
<li>
<p><code>bronze_zonificacion</code> â†’ GeometrÃ­as (polÃ­gonos) de zonas</p>
</li>
<li><strong>Formato</strong>: Shapefile â†’ DuckDB spatial</li>
<li>
<p><strong>CRS</strong>: EPSG:25830 (UTM 30N - EspaÃ±a Peninsular)</p>
</li>
<li>
<p><strong>Calendario Laboral</strong></p>
</li>
<li><code>bronze_calendario_laboral</code> â†’ Festivos nacionales, dÃ­as laborables</li>
<li><strong>PropÃ³sito</strong>: Clasificar dÃ­as en laborables/festivos/fin de semana</li>
</ol>
<h4 id="tecnicas-de-ingesta">TÃ©cnicas de Ingesta</h4>
<p><strong>Â¿Por quÃ© <code>COPY ... FROM</code> en lugar de <code>INSERT</code>?</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Slow (fila por fila)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
    <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO table VALUES (?)&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

<span class="c1"># Fast (bulk load)</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COPY bronze_table FROM &#39;</span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">&#39; (HEADER, DELIMITER &#39;,&#39;)&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Ventaja de <code>COPY</code></strong>:</p>
<ul>
<li><strong>10-100x mÃ¡s rÃ¡pido</strong> â†’ Carga en bloques, no fila por fila</li>
<li><strong>Menos overhead</strong> â†’ No crea transacciones por cada fila</li>
<li><strong>Auto-detecciÃ³n</strong> â†’ DuckDB infiere tipos de datos automÃ¡ticamente</li>
</ul>
<p><strong>Manejo de Errores</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COPY bronze_table FROM &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš  Error en </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">continue</span>  <span class="c1"># Sigue con el siguiente archivo</span>
</code></pre></div>

<p><strong>Â¿Por quÃ© <code>continue</code> y no <code>raise</code>?</strong></p>
<ul>
<li>Si un archivo CSV estÃ¡ corrupto, no queremos que pare toda la ingesta</li>
<li>Logs claros â†’ sabemos quÃ© archivo fallÃ³</li>
<li>Re-procesamiento parcial â†’ solo reingestan los archivos fallidos</li>
</ul>
<hr />
<h2 id="transformacion-a-silver-layer">ğŸ”„ TransformaciÃ³n a Silver Layer</h2>
<h3 id="script-srcprocess_silverpy">Script: <code>src/process_silver.py</code></h3>
<h4 id="optimizaciones-implementadas-modo-turbo">Optimizaciones Implementadas (Modo TURBO)</h4>
<p><strong>Problema Inicial</strong>: 1540 segundos (25 minutos) para procesar 1 mes
<strong>SoluciÃ³n Final</strong>: ~25 segundos para procesar 1 mes â†’ <strong>60x mÃ¡s rÃ¡pido</strong></p>
<h5 id="1-eliminacion-de-joins-en-insert">1. <strong>EliminaciÃ³n de JOINs en INSERT</strong></h5>
<p><strong>VersiÃ³n Original (LENTA)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">silver_fact_viajes</span>
<span class="k">SELECT</span><span class="w"> </span><span class="p">...</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">bronze_mitma_viajes</span><span class="w"> </span><span class="n">v</span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_zonas</span><span class="w"> </span><span class="n">zo</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">origen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zo</span><span class="p">.</span><span class="n">zone_id</span><span class="w">  </span><span class="c1">-- âŒ 100M Ã— 1000 filas</span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_zonas</span><span class="w"> </span><span class="n">zd</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">destino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zd</span><span class="p">.</span><span class="n">zone_id</span><span class="w"> </span><span class="c1">-- âŒ 100M Ã— 1000 filas</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">viajes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<p><strong>Problema</strong>: DuckDB necesita verificar integridad referencial â†’ cada fila de <code>bronze_mitma_viajes</code> (100M) se cruza con <code>silver_dim_zonas</code> (1000 filas) = 100M Ã— 1000 comparaciones.</p>
<p><strong>VersiÃ³n Optimizada (MODO TURBO)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">silver_fact_viajes</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(),</span><span class="w">  </span><span class="c1">-- ID generado</span>
<span class="w">    </span><span class="n">strptime</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">fecha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y%m%d&#39;</span><span class="p">)::</span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="k">CAST</span><span class="p">(</span><span class="k">RIGHT</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">periodo</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">),</span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">origen</span><span class="p">,</span><span class="w">  </span><span class="c1">-- â† Copia directa, sin JOIN</span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">destino</span><span class="p">,</span><span class="w"> </span><span class="c1">-- â† Copia directa, sin JOIN</span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">edad</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">sexo</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">viajes</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">viajes_km</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">bronze_db</span><span class="p">.</span><span class="n">bronze_mitma_viajes</span><span class="w"> </span><span class="n">v</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">viajes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<p><strong>Resultado</strong>: No hay JOINs â†’ carga directa bulk â†’ <strong>60x mÃ¡s rÃ¡pido</strong></p>
<p><strong>Â¿Por quÃ© es seguro eliminar los JOINs?</strong></p>
<ul>
<li>Las dimensiones (<code>silver_dim_zonas</code>, <code>silver_dim_calendario</code>) ya se poblaron ANTES</li>
<li>Si hay un <code>origen</code> invÃ¡lido en Bronze, simplemente no tendrÃ¡ match en queries posteriores</li>
<li>Trade-off: Velocidad vs. Integridad Referencial Estricta â†’ elegimos velocidad</li>
</ul>
<h5 id="2-procesamiento-mensual-incremental">2. <strong>Procesamiento Mensual Incremental</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_available_months</span><span class="p">(</span><span class="n">con</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detecta quÃ© meses hay en Bronze&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT DISTINCT</span>
<span class="s2">            CAST(LEFT(fecha, 4) AS INTEGER) as year,</span>
<span class="s2">            CAST(SUBSTRING(fecha, 5, 2) AS INTEGER) as month</span>
<span class="s2">        FROM bronze_db.bronze_mitma_viajes</span>
<span class="s2">        ORDER BY year, month</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Procesar mes a mes</span>
<span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">get_available_months</span><span class="p">(</span><span class="n">con</span><span class="p">):</span>
    <span class="n">process_month</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
</code></pre></div>

<p><strong>Ventaja</strong>:</p>
<ul>
<li><strong>Paralelizable</strong>: Cada mes es independiente</li>
<li><strong>Checkpointing</strong>: Si falla el mes de Marzo, Enero y Febrero ya estÃ¡n procesados</li>
<li><strong>Memoria acotada</strong>: Solo carga 1 mes en RAM a la vez</li>
</ul>
<h5 id="3-indices-en-bronze">3. <strong>Ãndices en Bronze</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">-- src/sql/bronze_indexes.sql</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_viajes_fecha</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">bronze_mitma_viajes</span><span class="p">(</span><span class="n">fecha</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_viajes_origen</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">bronze_mitma_viajes</span><span class="p">(</span><span class="n">origen</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_viajes_destino</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">bronze_mitma_viajes</span><span class="p">(</span><span class="n">destino</span><span class="p">);</span>
</code></pre></div>

<p><strong>Â¿Por quÃ© indexar Bronze si no hacemos queries complejas?</strong></p>
<ul>
<li>Los Ã­ndices aceleran <code>GROUP BY</code> y <code>ORDER BY</code></li>
<li>DuckDB usa Ã­ndices para optimizar <code>DISTINCT</code> (e.g., <code>get_available_months</code>)</li>
<li>Overhead mÃ­nimo en DuckDB â†’ crea Ã­ndices en segundos</li>
</ul>
<h5 id="4-pragmas-de-duckdb">4. <strong>Pragmas de DuckDB</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET preserve_insertion_order=false&quot;</span><span class="p">)</span>  <span class="c1"># No mantener orden â†’ mÃ¡s rÃ¡pido</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET memory_limit=&#39;16GB&#39;&quot;</span><span class="p">)</span>            <span class="c1"># Usa hasta 16GB RAM</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET max_temp_directory_size=&#39;80GB&#39;&quot;</span><span class="p">)</span> <span class="c1"># Permite usar disco para spill</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET threads=8&quot;</span><span class="p">)</span>                       <span class="c1"># Paraleliza en 8 cores</span>
</code></pre></div>

<p><strong>ExplicaciÃ³n</strong>:</p>
<ul>
<li><strong><code>preserve_insertion_order=false</code></strong>: DuckDB puede reordenar filas para optimizar â†’ +20% velocidad</li>
<li><strong><code>memory_limit='16GB'</code></strong>: Usuario tiene 32GB RAM â†’ usamos la mitad para DuckDB</li>
<li><strong><code>max_temp_directory_size='80GB'</code></strong>: Si no cabe en RAM, usa disco temporal</li>
<li><strong><code>threads=8</code></strong>: Aprovecha CPU multi-core (usuario tiene 8 cores)</li>
</ul>
<hr />
<h2 id="modelo-dimensional-silver">ğŸ“Š Modelo Dimensional Silver</h2>
<h3 id="star-schema-implementado">Star Schema Implementado</h3>
<div class="codehilite"><pre><span></span><code>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ silver_dim_zonas  â”‚
        â”‚ - zone_id (PK)    â”‚
        â”‚ - zone_name       â”‚
        â”‚ - zone_level      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†‘
                 â”‚
                 â”‚ FK
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ silver_fact_viajesâ”‚
        â”‚ - viaje_id (PK)   â”‚
        â”‚ - fecha (FK)      â”‚
        â”‚ - origen (FK)     â”‚
        â”‚ - destino (FK)    â”‚
        â”‚ - viajes          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ FK
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚silver_dim_calendarioâ”‚
        â”‚ - fecha (PK)      â”‚
        â”‚ - es_laborable    â”‚
        â”‚ - es_festivo      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>Â¿Por quÃ© Star Schema y no Snowflake?</strong></p>
<ul>
<li><strong>Simplicidad</strong>: Queries con menos JOINs â†’ mÃ¡s rÃ¡pidas</li>
<li><strong>DesnormalizaciÃ³n controlada</strong>: Las dimensiones tienen redundancia (e.g., <code>zone_name</code>) pero los hechos no</li>
<li><strong>BI-friendly</strong>: Herramientas como PowerBI/Tableau estÃ¡n optimizadas para Star Schemas</li>
</ul>
<p><strong>Ejemplo de Query AnalÃ­tico</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Top 10 flujos OD en Madrid en dÃ­as laborables</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">zo</span><span class="p">.</span><span class="n">zone_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">origen</span><span class="p">,</span>
<span class="w">    </span><span class="n">zd</span><span class="p">.</span><span class="n">zone_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">destino</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">viajes</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_viajes</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">silver_fact_viajes</span><span class="w"> </span><span class="n">v</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_zonas</span><span class="w"> </span><span class="n">zo</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">origen_zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zo</span><span class="p">.</span><span class="n">zone_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_zonas</span><span class="w"> </span><span class="n">zd</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">destino_zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zd</span><span class="p">.</span><span class="n">zone_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_calendario</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">fecha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">fecha</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">es_laborable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">zo</span><span class="p">.</span><span class="n">zone_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Madrid%&#39;</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">zo</span><span class="p">.</span><span class="n">zone_name</span><span class="p">,</span><span class="w"> </span><span class="n">zd</span><span class="p">.</span><span class="n">zone_name</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">viajes</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="gold-layer-modelo-de-gravedad">ğŸŒ Gold Layer: Modelo de Gravedad</h2>
<h3 id="implementacion-de-la-formula">ImplementaciÃ³n de la FÃ³rmula</h3>
<p>$$T_{ij} = k \cdot \frac{P_i \cdot E_j}{d_{ij}^2}$$</p>
<p><strong>Componentes</strong>:</p>
<ul>
<li>$T_{ij}$ â†’ Viajes teÃ³ricos entre zona $i$ y zona $j$</li>
<li>$P_i$ â†’ <strong>ProducciÃ³n</strong> de viajes de la zona $i$ (viajes salientes)</li>
<li>$E_j$ â†’ <strong>AtracciÃ³n</strong> de viajes de la zona $j$ (viajes entrantes)</li>
<li>$d_{ij}$ â†’ Distancia entre centroides en km (Haversine)</li>
<li>$k$ â†’ Factor de calibraciÃ³n global</li>
</ul>
<h3 id="sql-implementado-ctes">SQL Implementado (CTEs)</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">-- A. Calcular flujos base</span>
<span class="n">base_flows</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">v</span><span class="p">.</span><span class="n">origen_zone_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">v</span><span class="p">.</span><span class="n">destino_zone_id</span><span class="p">,</span>
<span class="w">        </span><span class="k">SUM</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">viajes</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">observed_trips</span><span class="p">,</span>
<span class="w">        </span><span class="c1">-- Distancia Haversine</span>
<span class="w">        </span><span class="mi">111</span><span class="p">.</span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SQRT</span><span class="p">(</span>
<span class="w">            </span><span class="n">POW</span><span class="p">(</span><span class="n">ao</span><span class="p">.</span><span class="n">centroid_lat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">centroid_lat</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">POW</span><span class="p">((</span><span class="n">ao</span><span class="p">.</span><span class="n">centroid_lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">centroid_lon</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">COS</span><span class="p">(...),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">distance_km</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">silver_fact_viajes</span><span class="w"> </span><span class="n">v</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_zona_atributos</span><span class="w"> </span><span class="n">ao</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">origen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ao</span><span class="p">.</span><span class="n">zone_id</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">silver_dim_zona_atributos</span><span class="w"> </span><span class="n">ad</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">destino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ad</span><span class="p">.</span><span class="n">zone_id</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="p">...</span>
<span class="p">),</span>

<span class="c1">-- B. Calcular ProducciÃ³n (Pi)</span>
<span class="n">zone_prod</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">origen_zone_id</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">observed_trips</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Pi</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">base_flows</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">origen_zone_id</span>
<span class="p">),</span>

<span class="c1">-- C. Calcular AtracciÃ³n (Ej)</span>
<span class="n">zone_attr</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">destino_zone_id</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">observed_trips</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Ej</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">base_flows</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">destino_zone_id</span>
<span class="p">),</span>

<span class="c1">-- D. Factor de gravedad (Pi * Ej / dÂ²)</span>
<span class="n">gravity_term</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">Pi</span><span class="p">,</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">Ej</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">Ej</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">POW</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">distance_km</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">gravity_factor</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">base_flows</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">zone_prod</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">origen_zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">zone_id</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">zone_attr</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">destino_zone_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">zone_id</span>
<span class="p">),</span>

<span class="c1">-- E. Calcular k global</span>
<span class="n">global_k</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">observed_trips</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">gravity_factor</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">k_factor</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">gravity_term</span>
<span class="p">)</span>

<span class="c1">-- F. Insertar con viajes teÃ³ricos</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="p">...,</span>
<span class="w">    </span><span class="n">observed_trips</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="n">gravity_factor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">k_factor</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">theoretical_trips</span><span class="p">,</span><span class="w">  </span><span class="c1">-- â† Tij</span>
<span class="w">    </span><span class="n">observed_trips</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">theoretical_trips</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ratio_obs_theo</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">gravity_term</span><span class="w"> </span><span class="k">g</span><span class="p">,</span><span class="w"> </span><span class="n">global_k</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
</code></pre></div>

<h3 id="interpretacion-de-resultados">InterpretaciÃ³n de Resultados</h3>
<p><strong>Ejemplo de Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Madrid distrito 08 â†’ Madrid distrito 08:
   Observado: 10,537,458 | Teorico: 1,465,149 | Ratio: 7.19
</code></pre></div>

<p><strong>Â¿QuÃ© significa Ratio = 7.19?</strong></p>
<ul>
<li>Hay <strong>7.19 veces MÃS viajes</strong> de los que predice el modelo de gravedad</li>
<li><strong>Causas posibles</strong>:</li>
<li>Viajes intrazonales (la gente vive y trabaja en la misma zona)</li>
<li>Atractores especiales (centros comerciales, hospitales)</li>
<li>Infraestructura (metro, cercanÃ­as) que reduce la "fricciÃ³n" de la distancia</li>
</ul>
<p><strong>Â¿Por quÃ© es Ãºtil este ratio?</strong></p>
<ul>
<li><strong>Ratio &gt; 1</strong>: La zona tiene mÃ¡s movilidad de la esperada â†’ invertir en transporte</li>
<li><strong>Ratio &lt; 1</strong>: La zona estÃ¡ subconectada â†’ oportunidad para mejorar accesibilidad</li>
<li><strong>PlanificaciÃ³n urbana</strong>: Identificar zonas que necesitan nuevas lÃ­neas de metro</li>
</ul>
<hr />
<h2 id="validacion-y-metricas-de-calidad">ğŸ¯ ValidaciÃ³n y MÃ©tricas de Calidad</h2>
<h3 id="1-validacion-de-ingesta-bronze">1. ValidaciÃ³n de Ingesta (Bronze)</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Verificar filas cargadas</span>
<span class="n">total_viajes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM bronze_mitma_viajes&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… </span><span class="si">{</span><span class="n">total_viajes</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> viajes cargados&quot;</span><span class="p">)</span>

<span class="c1"># Verificar rango temporal</span>
<span class="n">min_fecha</span><span class="p">,</span> <span class="n">max_fecha</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT MIN(fecha), MAX(fecha) FROM bronze_mitma_viajes</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“… Rango: </span><span class="si">{</span><span class="n">min_fecha</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">max_fecha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-validacion-de-integridad-silver">2. ValidaciÃ³n de Integridad (Silver)</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Verificar que no hay viajes con zonas invÃ¡lidas</span>
<span class="n">orphan_viajes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT COUNT(*)</span>
<span class="s2">    FROM silver_fact_viajes v</span>
<span class="s2">    LEFT JOIN silver_dim_zonas z ON v.origen_zone_id = z.zone_id</span>
<span class="s2">    WHERE z.zone_id IS NULL</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">if</span> <span class="n">orphan_viajes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš  </span><span class="si">{</span><span class="n">orphan_viajes</span><span class="si">}</span><span class="s2"> viajes con origen invÃ¡lido&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3-estadisticas-descriptivas-gold">3. EstadÃ­sticas Descriptivas (Gold)</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Top zonas por volumen</span>
<span class="n">top_zones</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT zone_name, SUM(viajes) as total</span>
<span class="s2">    FROM silver_fact_viajes v</span>
<span class="s2">    JOIN silver_dim_zonas z ON v.origen_zone_id = z.zone_id</span>
<span class="s2">    GROUP BY zone_name</span>
<span class="s2">    ORDER BY total DESC</span>
<span class="s2">    LIMIT 10</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="rendimiento-alcanzado">ğŸš€ Rendimiento Alcanzado</h2>
<h3 id="benchmark-final">Benchmark Final</h3>
<table>
<thead>
<tr>
<th>MÃ©trica</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TamaÃ±o Bronze</strong></td>
<td>3.2 GB</td>
</tr>
<tr>
<td><strong>Filas totales viajes</strong></td>
<td>183 millones</td>
</tr>
<tr>
<td><strong>Filas totales personas</strong></td>
<td>45 millones</td>
</tr>
<tr>
<td><strong>Tiempo ingesta Bronze</strong></td>
<td>~3 min</td>
</tr>
<tr>
<td><strong>Tiempo proceso Silver (1 mes)</strong></td>
<td>~25 seg</td>
</tr>
<tr>
<td><strong>Tiempo proceso Gold</strong></td>
<td>~25 seg</td>
</tr>
<tr>
<td><strong>RAM usada (pico)</strong></td>
<td>12 GB</td>
</tr>
<tr>
<td><strong>Espacio disco temporal</strong></td>
<td>45 GB</td>
</tr>
</tbody>
</table>
<h3 id="optimizaciones-clave">Optimizaciones Clave</h3>
<ol>
<li>âœ… <strong>Bulk Loading</strong> â†’ 10-100x mÃ¡s rÃ¡pido que INSERT fila por fila</li>
<li>âœ… <strong>Sin JOINs en INSERT</strong> â†’ 60x mÃ¡s rÃ¡pido en Silver</li>
<li>âœ… <strong>Procesamiento mensual</strong> â†’ Paralelizable, checkpointing</li>
<li>âœ… <strong>Ãndices estratÃ©gicos</strong> â†’ Aceleran GROUP BY y ORDER BY</li>
<li>âœ… <strong>Pragmas DuckDB</strong> â†’ Aprovecha 16GB RAM y 8 cores</li>
</ol>
<hr />
<h2 id="decisiones-tecnicas-clave-para-defender">ğŸ“š Decisiones TÃ©cnicas Clave (Para Defender)</h2>
<h3 id="1-por-que-duckdb-y-no-postgresql">1. Â¿Por quÃ© DuckDB y no PostgreSQL?</h3>
<p><strong>Respuesta</strong>:</p>
<ul>
<li>PostgreSQL es OLTP â†’ optimizado para transacciones (INSERT/UPDATE)</li>
<li>DuckDB es OLAP â†’ optimizado para anÃ¡lisis (GROUP BY, agregaciones)</li>
<li>Nuestro caso de uso es 100% analÃ­tico â†’ no necesitamos ACID completo</li>
<li>DuckDB procesa agregaciones 10-100x mÃ¡s rÃ¡pido que Postgres</li>
</ul>
<h3 id="2-por-que-eliminar-joins-en-insert-si-pierde-integridad-referencial">2. Â¿Por quÃ© eliminar JOINs en INSERT si pierde integridad referencial?</h3>
<p><strong>Respuesta</strong>:</p>
<ul>
<li>Trade-off consciente: Velocidad vs. Integridad Estricta</li>
<li>Las dimensiones se cargan ANTES â†’ sabemos que las zonas existen</li>
<li>Si hay datos invÃ¡lidos, fallarÃ¡n en queries posteriores (fail-fast)</li>
<li>Para datos de movilidad (millones de filas), la velocidad es crÃ­tica</li>
<li>Podemos validar post-carga con queries especÃ­ficas</li>
</ul>
<h3 id="3-por-que-3-capas-bronzesilvergold-y-no-2">3. Â¿Por quÃ© 3 capas (Bronze/Silver/Gold) y no 2?</h3>
<p><strong>Respuesta</strong>:</p>
<ul>
<li><strong>Bronze</strong>: Preserve raw data â†’ si se rompe Silver, puedo reprocesar</li>
<li><strong>Silver</strong>: Clean data for analysts â†’ modelo dimensional listo para BI</li>
<li><strong>Gold</strong>: Pre-aggregated metrics â†’ queries instantÃ¡neas para dashboards</li>
<li>Cada capa tiene un propÃ³sito y usuario distinto</li>
<li>SeparaciÃ³n de preocupaciones â†’ mantiene el cÃ³digo modular</li>
</ul>
<h3 id="4-por-que-usar-ctes-with-en-el-modelo-de-gravedad">4. Â¿Por quÃ© usar CTEs (WITH) en el Modelo de Gravedad?</h3>
<p><strong>Respuesta</strong>:</p>
<ul>
<li><strong>Legibilidad</strong>: Cada CTE tiene un nombre descriptivo (base_flows, zone_prod)</li>
<li><strong>Debugging</strong>: Puedo ejecutar cada CTE individualmente para verificar resultados</li>
<li><strong>OptimizaciÃ³n</strong>: DuckDB puede materializar o inline CTEs segÃºn sea Ã³ptimo</li>
<li><strong>Mantenibilidad</strong>: FÃ¡cil agregar nuevas mÃ©tricas (e.g., <code>zone_population</code>)</li>
</ul>
<h3 id="5-como-manejas-errores-en-la-ingesta">5. Â¿CÃ³mo manejas errores en la ingesta?</h3>
<p><strong>Respuesta</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COPY bronze_table FROM &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš  Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">continue</span>  <span class="c1"># Sigue con el siguiente archivo</span>
</code></pre></div>

<ul>
<li>No queremos que 1 archivo corrupto pare toda la ingesta</li>
<li>Logs claros â†’ sabemos quÃ© archivo fallÃ³</li>
<li>Re-procesamiento parcial â†’ solo reingesto los fallidos</li>
</ul>
<hr />
<h2 id="cumplimiento-de-objetivos-del-sprint-2">âœ… Cumplimiento de Objetivos del Sprint 2</h2>
<table>
<thead>
<tr>
<th>Objetivo</th>
<th>Estado</th>
<th>Evidencia</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ingesta MITMA</td>
<td>âœ…</td>
<td><code>bronze_mitma_viajes</code>, <code>bronze_mitma_personas</code></td>
</tr>
<tr>
<td>Ingesta INE</td>
<td>âœ…</td>
<td><code>bronze_ine_zones</code>, <code>bronze_ine_demographics</code>, <code>bronze_ine_economic</code></td>
</tr>
<tr>
<td>ValidaciÃ³n Bronze</td>
<td>âœ…</td>
<td>Scripts de conteo, rangos temporales, NULL checks</td>
</tr>
<tr>
<td>Tablas Silver</td>
<td>âœ…</td>
<td>Star schema: <code>silver_dim_zonas</code>, <code>silver_dim_calendario</code>, <code>silver_fact_viajes</code></td>
</tr>
<tr>
<td>OptimizaciÃ³n</td>
<td>âœ…</td>
<td>60x mÃ¡s rÃ¡pido (25 seg/mes vs. 1540 seg/mes inicial)</td>
</tr>
<tr>
<td>Gold Analytics</td>
<td>âœ…</td>
<td>Top flujos OD, Modelo de Gravedad, Patrones horarios</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="conceptos-clave-para-el-profesor">ğŸ“ Conceptos Clave para el Profesor</h2>
<ol>
<li><strong>Medallion Architecture</strong> â†’ Bronze (raw) â†’ Silver (modeled) â†’ Gold (aggregated)</li>
<li><strong>OLAP vs. OLTP</strong> â†’ DuckDB es OLAP (columnar, vectorizado)</li>
<li><strong>Bulk Loading</strong> â†’ <code>COPY FROM</code> es 10-100x mÃ¡s rÃ¡pido que <code>INSERT</code></li>
<li><strong>Star Schema</strong> â†’ Modelo dimensional para anÃ¡lisis</li>
<li><strong>Modelo de Gravedad</strong> â†’ Formula $T_{ij} = k \cdot \frac{P_i \cdot E_j}{d_{ij}^2}$ para predecir movilidad</li>
<li><strong>Trade-offs</strong> â†’ Velocidad vs. Integridad (eliminamos JOINs en INSERT)</li>
<li><strong>Pragmas DuckDB</strong> â†’ ConfiguraciÃ³n de memoria, threads, orden</li>
</ol>
<hr />
<h2 id="proximos-pasos-sprint-3">ğŸ“Œ PrÃ³ximos Pasos (Sprint 3)</h2>
<ol>
<li>
<p><strong>VisualizaciÃ³n</strong></p>
</li>
<li>
<p>Dashboard interactivo con Kepler.gl</p>
</li>
<li>Mapa de calor de flujos OD</li>
<li>
<p>Comparativa observado vs. teÃ³rico (Modelo de Gravedad)</p>
</li>
<li>
<p><strong>Modelos Predictivos</strong></p>
</li>
<li>
<p>Forecasting de demanda con Prophet/ARIMA</p>
</li>
<li>
<p>Clustering de zonas por patrones de movilidad</p>
</li>
<li>
<p><strong>OptimizaciÃ³n Avanzada</strong></p>
</li>
<li>Particionamiento de tablas por mes</li>
<li>CompresiÃ³n de datos (Parquet)</li>
<li>Query caching</li>
</ol>
<hr />
<p><strong>Fecha</strong>: 2025-12-04<br />
<strong>Autor</strong>: [Tu Nombre]<br />
<strong>Repositorio</strong>: mobility_lakehouse<br />
<strong>Stack</strong>: Python 3.11 + DuckDB 0.9 + GeoPandas + Kepler.gl</p>
        
        <div class="footer">
            <p>Mobility Lakehouse Project - Sprint 2</p>
            <p>Para guardar como PDF: Presiona <strong>Ctrl+P</strong> â†’ Selecciona "Guardar como PDF"</p>
        </div>
    </div>
</body>
</html>
